<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6" layout:decorate="~{layout}">

<th:block layout:fragment="pagetitle">
    <div th:replace="~{partials/title-meta :: title-meta('Articles')}"></div>
</th:block>

<head>
</head>

<body>
<div layout:fragment="content">
    <div th:replace="~{partials/page-title :: page-title('VN news','Articles')}"></div>

    <!-- Alert Messages -->
    <div class="row">
        <div class="col-lg-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${success != null}">
                <i class="ri-check-double-line me-1 align-middle"></i> <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${error != null}">
                <i class="ri-error-warning-line me-1 align-middle"></i> <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">

        <div class="col-lg-12 mt-3">
            <div class="d-flex align-items-center gap-2">
                <input class="form-control" type="text" id="searchInput" placeholder="Search by title" />
                <button type="button" class="btn btn-primary" id="searchButton"> Tìm</button>
            </div>

            <!-- Add filter to filter by category -->
            <div class="d-flex align-items-center gap-2 mt-2">
                <select class="form-select" id="categoryFilter">
                    <option value="">Tất cả</option>
                    <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}">
                    </option>
                </select>

                <select class="form-select" id="statusFilter">
                    <option value="">Tất cả trạng thái</option>
                    <option value="DRAFT">Draft</option>
                    <option value="PENDING">Pending</option>
                    <option value="PUBLISHED">Published</option>
                    <option value="REJECTED">Rejected</option>
                </select>

                <select class="form-select" id="publishedDateFilter">
                    <option value="">Tất cả ngày</option>
                    <option th:value="1">1 ngày qua</option>
                    <option th:value="7">1 tuần qua</option>
                    <option th:value="30">1 tháng qua</option>
                    <option th:value="365">1 năm qua</option>
                </select>

                <button type="button" class="btn btn-primary" id="filterButton">Lọc</button>
            </div>
        </div>
    </div>


    <!-- Articles Table -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Danh sách bài báo</h4>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        <div class="col" th:each="article : ${articles}">
                            <div class="card h-100">
                                <!-- Top Image -->
                                <img th:if="${article.topImageUrl != null}" th:src="${article.topImageUrl}"
                                     class="card-img-top" alt="Article Image"
                                     style="height: 200px; object-fit: cover;">
                                <div th:unless="${article.topImageUrl != null}"
                                     class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                     style="height: 200px;">
                                    <i class="ri-newspaper-line fs-1 text-muted"></i>
                                </div>

                                <div class="card-body">
                                    <!-- Category Badge -->
                                    <div class="mb-2">
                                            <span class="badge bg-primary-subtle text-primary"
                                                  th:text="${article.categoryId != null ? article.categoryId.name : 'Uncategorized'}"></span>
                                        <span th:switch="${article.status}">
                                                <span th:case="'DRAFT'"
                                                      class="badge bg-secondary-subtle text-secondary">Draft</span>
                                                <span th:case="'PENDING'"
                                                      class="badge bg-warning-subtle text-warning">Pending</span>
                                                <span th:case="'PUBLISHED'"
                                                      class="badge bg-success-subtle text-success">Published</span>
                                                <span th:case="'REJECTED'"
                                                      class="badge bg-danger-subtle text-danger">Rejected</span>
                                                <span th:case="*" class="badge bg-info-subtle text-info"
                                                      th:text="${article.status}"></span>
                                            </span>
                                    </div>

                                    <!-- Title -->
                                    <h5 class="card-title">
                                        <!-- Bằng dòng đúng -->
                                        <a th:href="@{/editor/articles/{slug}_{id}(slug=${article.slug}, id=${article.id})}" class="text-dark" th:text="${article.title}"></a>
                                    </h5>

                                    <!-- Summary -->
                                    <p class="card-text text-muted" th:if="${article.summary != null}"
                                       th:text="${#strings.abbreviate(article.summary, 100)}"></p>

                                    <!-- Source with Logo (ADDED) -->
                                    <div class="d-flex align-items-center mb-2"
                                         th:if="${article.generatorId != null}">
                                        <div class="me-2">
                                            <img th:if="${article.generatorId.logoUrl != null}"
                                                 th:src="${article.generatorId.logoUrl}" alt="Source Logo"
                                                 class="rounded-circle"
                                                 style="width: 24px; height: 24px; object-fit: cover;">
                                            <i th:unless="${article.generatorId.logoUrl != null}"
                                               class="ri-newspaper-line"></i>
                                        </div>
                                        <small class="text-muted" th:text="${article.generatorId.name}">Source
                                            Name</small>
                                    </div>

                                    <!-- Published Date -->
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="ri-calendar-line me-1"></i>
                                            <span
                                                    th:text="${article.publishedDate != null ? #dates.format(article.publishedDate, 'dd MMM yyyy') : 'Not published'}"></span>
                                        </small>
                                    </p>
                                </div>

                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted" th:text="'ID: ' + ${article.id}"></small>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-soft-secondary dropdown-toggle"
                                                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="ri-more-fill align-middle"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item"
                                                       th:href="@{/editor/articles/{slug}_{id}(slug=${article.slug}, id=${article.id})}">
                                                        <i class="ri-eye-fill align-bottom me-2 text-muted"></i>
                                                        Detail
                                                    </a>
                                                </li>
                                                <li class="dropdown-divider"></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div class="text-center py-5" th:if="${articles.isEmpty()}">
                        <i class="ri-file-list-3-line fs-1 text-muted mb-3 d-block"></i>
                        <h5>Không có bài viết nào</h5>
                        <p class="text-muted">Không tìm thấy bài viết nào phù hợp với bộ lọc hiện tại.</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row g-0 text-center text-sm-start align-items-center mb-3">
        <div class="col-sm-6">
            <p class="mb-0">Hiển thị <span th:text="${articles.size()}"></span> bài viết</p>
        </div>
        <div class="col-sm-6">
            <ul class="pagination pagination-separated justify-content-center justify-content-sm-end mb-sm-0"
                th:if="${totalItems > 0}">

                <!-- Previous -->
                <li class="page-item" th:classappend="${currentPage <= 1} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{'/editor/articles?page=' + (${currentPage - 1})
                            + '&categoryId=' + ${(categoryFilter != null) ? categoryFilter : ''}
                            + '&status=' + ${(statusFilter != null) ? statusFilter : ''}
                            + '&publishedDates=' + ${(publishedDateFilter != null) ? publishedDateFilter : ''}
                            + '&title=' + ${(title != null) ? title : ''}}"
                       th:ariaDisabled="${currentPage <= 1}" tabindex="-1">
                        <i class="mdi mdi-chevron-left"></i>
                    </a>
                </li>

                <!-- Pages -->
                <li class="page-item" th:each="page : ${#numbers.sequence(1, totalPages)}"
                    th:classappend="${page == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{'/editor/articles?page=' + ${page}
                            + '&categoryId=' + ${(categoryFilter != null) ? categoryFilter : ''}
                            + '&status=' + ${(statusFilter != null) ? statusFilter : ''}
                            + '&publishedDates=' + ${(publishedDateFilter != null) ? publishedDateFilter : ''}
                            + '&title=' + ${(title != null) ? title : ''}}"
                       th:text="${page}">1</a>
                </li>

                <!-- Next -->
                <li class="page-item" th:classappend="${currentPage >= totalItems} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{'/editor/articles?page=' + (${currentPage + 1})
                            + '&categoryId=' + ${(categoryFilter != null) ? categoryFilter : ''}
                            + '&status=' + ${(statusFilter != null) ? statusFilter : ''}
                            + '&publishedDates=' + ${(publishedDateFilter != null) ? publishedDateFilter : ''}
                            + '&title=' + ${(title != null) ? title : ''}}"
                       th:ariaDisabled="${currentPage >= totalItems}" tabindex="-1">
                        <i class="mdi mdi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>

</div>

<th:block layout:fragment="pagejs">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            if (searchInput && searchButton) {
                searchButton.addEventListener('click', function () {
                    const searchTerm = searchInput.value.trim();
                    const url = new URL(window.location.href);
                    if (searchTerm) {
                        url.searchParams.set('title', searchTerm);
                    } else {
                        url.searchParams.delete('title');
                    }
                    url.searchParams.set('page', '1'); // Reset to first page on new search
                    window.location.href = url.toString();
                });

                // Load initial search term from URL
                const url = new URL(window.location.href);
                const nameParam = url.searchParams.get('title');
                if (nameParam) {
                    searchInput.value = nameParam;
                }
            }

            // filter category
            const filterButton = document.getElementById('filterButton');
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            const publishedDateFilter = document.getElementById('publishedDateFilter');

            if (filterButton) {
                filterButton.addEventListener('click', function () {
                    const url = new URL(window.location.href);
                    const category = categoryFilter.value;
                    const status = statusFilter.value;
                    const publishedDate = publishedDateFilter.value;

                    if (category !== '') {
                        url.searchParams.set('categoryId', category);
                    } else {
                        url.searchParams.delete('categoryId');
                    }

                    if (status !== '') {
                        url.searchParams.set('status', status);
                    } else {
                        url.searchParams.delete('status');
                    }

                    if (publishedDate !== '') {
                        url.searchParams.set('publishedDates', publishedDate);
                    } else {
                        url.searchParams.delete('publishedDates');
                    }

                    url.searchParams.set('page', '1');
                    window.location.href = url.toString();
                });

                window.addEventListener('DOMContentLoaded', function () {
                    const url = new URL(window.location.href);
                    const categoryParam = url.searchParams.get('categoryId');
                    const statusParam = url.searchParams.get('status');
                    const publishedDateParam = url.searchParams.get('publishedDates');
                    if (categoryParam) {
                        categoryFilter.value = categoryParam;
                    }
                    if (statusParam) {
                        statusFilter.value = statusParam;
                    }
                    if (publishedDateParam) {
                        publishedDateFilter.value = publishedDateParam;
                    }
                });
            }

            // Reset filters
            const resetFilterButton = document.getElementById('resetFilter');
            if (resetFilterButton) {
                resetFilterButton.addEventListener('click', function () {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('title');
                    url.searchParams.delete('categoryId');
                    url.searchParams.delete('status'); // Thay đổi từ isActive sang status
                    url.searchParams.delete('publishedDates');
                    url.searchParams.set('page', '1'); // Reset to first page
                    window.location.href = url.toString();
                });
            }
        });
    </script>
</th:block>
</body>

</html>